<!DOCTYPE html>
<html>
<head>
    <title>Arduino AR Stream</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <!-- UI Overlay voor Knoppen -->
    <div id="ui-controls" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 10px; width: 90%; justify-content: center;">
        <button id="btn-exit" onclick="exitAR()" style="padding: 12px 20px; background: #ff4444; color: white; border: none; border-radius: 8px; font-weight: bold;">Stop AR</button>
        <button id="btn-enter" onclick="enterAR()" style="display: none; padding: 12px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-weight: bold;">Start AR</button>
        <button onclick="window.location.href='index.html'" style="padding: 12px 20px; background: #2196F3; color: white; border: none; border-radius: 8px; font-weight: bold;">Naar Index</button>
    </div>

    <!-- Live Data Dashboard (Bovenaan) -->
    <div id="data-display" style="position: absolute; top: 20px; left: 20px; z-index: 1000; background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px; font-family: sans-serif;">
        <div style="font-size: 12px; opacity: 0.8;">Live Afstand:</div>
        <div style="font-size: 24px; font-weight: bold;"><span id="distance">--</span> cm</div>
    </div>

    <a-scene id="ar-scene" embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <!-- Hiro Marker -->
        <a-marker preset="hiro">
            <!-- Achtergrond paneel -->
            <a-plane position="0 0 0" rotation="-90 0 0" width="1.5" height="0.6" color="#222" opacity="0.8"></a-plane>
            
            <!-- Dynamische tekst -->
            <a-text id="distanceText" 
                    value="Wachten op data..." 
                    position="0 0.2 0" 
                    rotation="-90 0 0" 
                    color="#00FF00" 
                    align="center" 
                    width="4">
            </a-text>
        </a-marker>

        <!-- Overlay voor de meetgegevens in AR -->
        <div style="position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px; font-family: sans-serif;">
            <div style="font-size: 12px; opacity: 0.8;">Live Afstand:</div>
            <div style="font-size: 24px; font-weight: bold;"><span id="distance">--</span> cm</div>
            <div id="status" style="font-size: 10px; color: #4CAF50;">Verbinden...</div>
        </div>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        function exitAR() {
            const scene = document.querySelector('a-scene');
            const video = document.querySelector('video');
            
            // Verberg de scene
            scene.style.display = 'none';
            // Stop de camera tracks
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            if (video) video.style.display = 'none';

            document.getElementById('btn-exit').style.display = 'none';
            document.getElementById('btn-enter').style.display = 'block';
        }

        function enterAR() {
            // Herladen is de meest betrouwbare manier om de camera/AR-context opnieuw te initialiseren
            window.location.reload();
        }

        // WebSocket logica
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socket = new WebSocket(`${protocol}//${window.location.host}/ws`);

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'sensor') {
                const dist = data.distance.toFixed(1);
                // Update zowel de AR tekst als de overlay tekst
                document.getElementById("distance").textContent = dist;
                const arText = document.querySelector("#distanceText");
                if(arText) arText.setAttribute("value", `Afstand: ${dist} cm`);
            }
        };
    </script>
</body>
</html>